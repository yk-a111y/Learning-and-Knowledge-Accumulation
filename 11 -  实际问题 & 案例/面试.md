
# æ•°å­—äººç¼–è¾‘å™¨

æ•°å­—äººé€‰æ‹©Fabricçš„åŸå› ï¼šhttps://juejin.cn/post/7243725952789217317  (2Då›¾å½¢åº“ä¼˜åŠ£)

## å†å²è®°å½•
å†å²è®°å½•ä¼˜åŒ–ä¸»è¦ç›®çš„åœ¨äºï¼šç”»é¢å…ƒç´ è¿‡å¤šï¼Œundo/redoä¼šé€ æˆç”»å¸ƒå¡é¡¿ï¼Œå°¤å…¶æ˜¯åœ¨è¿ç»­å¤šæ¬¡ç‚¹å‡»çš„æƒ…å†µä¸‹ï¼Œæç«¯æ¡ä»¶ä¼šå¯¼è‡´æµè§ˆå™¨å´©æºƒã€‚

### åˆ†å±‚ç¼“å­˜
å°†ç”»å¸ƒå…ƒç´ åˆ†ä¸ºï¼š**é™æ€å†…å®¹**ç¼“å­˜å±‚ï¼ˆèƒŒæ™¯ã€æ•°å­—äººã€æ–‡æœ¬ï¼‰ã€**åŠ¨æ€å†…å®¹**ç¼“å­˜å±‚ï¼ˆç›´æ’­é—´è£…é¥°å…ƒç´ ï¼‰ã€åˆæˆå±‚ï¼ˆå°†åŠ¨é™äºŒè€…ç»“åˆï¼Œæ˜¾ç¤ºåˆ°å‰å°ï¼‰
```js
class LayerRender {
  constructor(bufferSystem) {
	this.bufferSystem = bufferSystem;
	this.staticElements = []; // ä¸å¸¸å˜åŒ–çš„å…ƒç´ 
	this.dynamicElements = []; // ç»å¸¸å˜åŒ–çš„å…ƒç´ 
  };

  // ğŸŒŸ åˆ†å±‚æ¸²æŸ“ï¼Œåªé‡ç»˜å˜åŒ–çš„å±‚
  render() {
	// é™æ€å±‚ï¼ˆå¾ˆå°‘é‡ç»˜ï¼‰
	if (this.bufferSystem.staticBufferDirty) {
		this.renderStaticLayer();
		this.bufferSystem.staticBufferDirty = false;
	}
	
	// åŠ¨æ€å±‚ï¼ˆéœ€è¦é‡ç»˜æ—¶æ‰é‡ç»˜ï¼‰
	if (this.bufferSystem.dynamicBufferDirty) {
		this.renderDynamicLayer();
		this.bufferSystem.dynamicBufferDirty = false;
	}
	
	// åˆæˆæœ€ç»ˆç”»é¢
	this.compositeLayer();
  }

  compositeLayer() {
    const ctx = this.bufferSystem.compositeBuffer.ctx;
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        
	// åˆæˆå„å±‚
	ctx.drawImage(this.bufferSystem.staticBuffer.canvas, 0, 0);
	ctx.drawImage(this.bufferSystem.dynamicBuffer.canvas, 0, 0);
        
	// æ˜¾ç¤ºåˆ°å‰å°
	this.editor.displayCtx.clearRect(0, 0, this.editor.displayCanvas.width, this.editor.displayCanvas.height);
	this.editor.displayCtx.drawImage(this.bufferSystem.compositeBuffer.canvas, 0, 0);
    }
}
```

### æ™ºèƒ½ & ç¦»å± Canvas
åˆ›å»ºä¸€ä¸ªç¦»å±Canvasï¼Œå®½é«˜ä¸compositeBuffer.canvasç›¸åŒã€‚å°†å®Œæ•´çš„ç¼“å­˜æ•°æ®ä¿å­˜åˆ°ç¦»å±Canvasä¸­ï¼ŒçœŸæ­£éœ€è¦å±•ç¤ºçš„æ—¶å€™ï¼Œç›´æ¥è°ƒç”¨ä¸€æ¬¡`drawImage`æ–¹æ³•ï¼Œæé«˜æ•ˆç‡ã€‚

ä½¿ç”¨ç¦»å±canvaså¹¶ä¸æ˜¯åŒç¼“å†²ï¼Œè€Œæ˜¯æŠŠç¦»å±canvaså½“æˆä¸€ä¸ªç¼“å­˜åŒºã€‚æŠŠéœ€è¦é‡å¤ç»˜åˆ¶çš„ç”»é¢æ•°æ®è¿›è¡Œç¼“å­˜èµ·æ¥ï¼Œå‡å°‘è°ƒç”¨canvasçš„APIçš„æ¶ˆè€—

ç»˜åˆ¶æ—¶é—´è¾ƒé•¿å¯¼è‡´äº†é—ªå±ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯æ–°å»ºä¸€ä¸ª canvas ä½œä¸º **ç¼“å­˜ canvas**ï¼Œé€šè¿‡ ç¼“å­˜ canvas å®Œæˆç»˜åˆ¶è¿‡ç¨‹ï¼Œç»˜åˆ¶å®Œæˆåï¼Œç›´æ¥å°† ç¼“å­˜ canvas å¤åˆ¶åˆ°åŸæ¥çš„ canvas
```js
updateCanvas(){
    const canvas = document.getElementById('canvas'); // è·å–é¡µé¢ä¸­çš„ canvas
    const ctx = canvas.getContext('2d');
    
    const tempCanvas = document.createElement('canvas'); // æ–°å»ºä¸€ä¸ª canvas ä½œä¸ºç¼“å­˜ canvas
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = 1448; tempCanvas.height = 750; // è®¾ç½®å®½é«˜

    // å¼€å§‹ç»˜åˆ¶
    tempCtx.drawImage(bg,0,0); // èƒŒæ™¯
    ... // çœç•¥å…¶ä»–ç»˜åˆ¶è¿‡ç¨‹
    
    // ç¼“å­˜ canvas ç»˜åˆ¶å®Œæˆ
    
    ctx.clearRect(0,0,1448,750); // æ¸…ç©ºæ—§ canvas
    ctx.drawImage(tempCanvas,0,0); // *å…³é”®ä»£ç ï¼šå°†ç¼“å­˜ canvas å¤åˆ¶åˆ°æ—§çš„ canvas
}
```

ç¦»å±canvasè¿˜æœ‰ä¸€ä¸ª**æ³¨æ„äº‹é¡¹**ï¼Œå¦‚æœä½ åšçš„æ•ˆæœæ˜¯ä¼šå°†å¯¹è±¡ä¸åœåœ°åˆ›å»ºå’Œé”€æ¯ï¼Œè¯·æ…é‡ä½¿ç”¨ç¦»å±canvasï¼›

å› ä¸ºå¦‚æœè¿™æ ·ç»‘å®šï¼Œå½“å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œç¦»å±canvasä¹Ÿä¼šè¢«é”€æ¯ï¼Œè€Œå¤§é‡çš„ç¦»å±canvasä¸åœåœ°è¢«åˆ›å»ºå’Œé”€æ¯ï¼Œä¼šå¯¼è‡´canvas bufferè€—è´¹å¤§é‡GPUèµ„æºï¼Œå®¹æ˜“é€ æˆæµè§ˆå™¨å´©æºƒæˆ–è€…ä¸¥é‡å¡å¸§ç°è±¡ã€‚è§£å†³åŠæ³•å°±æ˜¯å¼„ä¸€ä¸ªç¦»å±canvasæ•°ç»„ï¼Œé¢„å…ˆè£…è¿›è¶³å¤Ÿæ•°é‡çš„ç¦»å±canvasï¼Œä»…å°†ä»ç„¶å­˜æ´»çš„å¯¹è±¡ç¼“å­˜èµ·æ¥ï¼Œå½“å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œå†è§£é™¤ç¼“å­˜ã€‚è¿™æ ·å°±ä¸ä¼šå¯¼è‡´ç¦»å±canvasè¢«é”€æ¯äº†ã€‚

â€œ-------------------------------------------------------------------------â€

ä¸šå†…ä¹Ÿæœ‰`å¢é‡å­˜å‚¨å†å²è®°å½•`çš„æ–¹æ¡ˆï¼Œå³æ¯æ¬¡å°å˜åŠ¨ä¸å­˜å‚¨æ•´ä¸ªCanvasæ•°æ®ï¼Œåªå¯¹æŒ‡å®šobjectIdçš„objectåšå˜åŒ–ï¼ŒèŠ‚çœå¤§é‡ç»˜åˆ¶æ—¶é—´ã€‚
## éŸ³é¢‘æ³¢å³°
## AIé…éŸ³å’Œå­—å¹•åˆ‡å‰²
## å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥
ä» [[2- å‰ç«¯æ€§èƒ½ä¼˜åŒ–#å›¾ç‰‡æ‡’åŠ è½½ | å›¾ç‰‡æ‡’åŠ è½½]] å¼€å§‹
## é€šç”¨èµ„æºæ‡’åŠ è½½åº“
[[2- å‰ç«¯æ€§èƒ½ä¼˜åŒ–#é€šç”¨èµ„æºæ‡’åŠ è½½åº“ | é€šç”¨èµ„æºæ‡’åŠ è½½åº“]]
# äº‘å°åº—
## é£æ§
### è·ç¦»é£æ§
### ç”µè¯é£æ§
## åœ°å›¾ç“¦ç‰‡å¼æ¸²æŸ“

# FlowScriptæ’ä»¶
## MV3çƒ­æ›´æ–°
## ç”»å¸ƒä¸handler
### ReactFlow
### handlerå¼€å‘æ­¥éª¤
## å·¥ä½œæµå¼•æ“
## JS handler
## é˜²è·¨åŸŸä»£ç æ³¨å…¥
# CodeGen_Vanilla
è¯¦è§ [[CodeGen_Vanilla | P2Cå¹³å°_CodeGen]]
# å‰ç«¯ç›‘æ§å¹³å°

è¯¦è§ [[1 - ç›‘æ§æµç¨‹è®¾è®¡ | ç›‘æ§æµç¨‹è®¾è®¡]]
## é”™è¯¯æ˜¯æ€ä¹ˆç›‘æ§çš„
## å½•å±çš„æ—¶æœºå’Œæ€§èƒ½
## 

â€œ---------------------------------------------------------------â€
# Excalidraw
## ä¸»ç”»æ¿

### æ‰¹é‡çŠ¶æ€æ›´æ–° & é˜²æŠ–

withBatchedUpdatesåŒ…è£…å…³é”®æ–¹æ³•ï¼Œå°†å¤šæ¬¡æ“ä½œåˆå¹¶ä¸ºä¸€æ¬¡ï¼Œ**æå‡æ€§èƒ½**ã€**é˜²æ­¢ç”¨æˆ·çœ‹åˆ°æ›´æ–°è¿‡ç¨‹çš„ä¸­é—´æ€**
å…¶æœ¬è´¨æ˜¯ä½¿ç”¨äº†Reactåº“çš„`unstable_batchedUpdates`æ–¹æ³•
```js
// é—®é¢˜ï¼šç”¨æˆ·å¯èƒ½çœ‹åˆ°ä¸ä¸€è‡´çš„ä¸­é—´çŠ¶æ€
function updateUserInfo() {
  setLoading(true);        // æ¸²æŸ“1: loading=true, user=æ—§æ•°æ®
  setUser(newUserData);    // æ¸²æŸ“2: loading=true, user=æ–°æ•°æ®
  setLoading(false);       // æ¸²æŸ“3: loading=false, user=æ–°æ•°æ®
}

// è§£å†³ï¼šæ‰¹é‡æ›´æ–°ç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
const batchedUpdateUserInfo = withBatchedUpdates(() => {
  setLoading(true);
  setUser(newUserData);
  setLoading(false);
  // åªæœ‰ä¸€æ¬¡æ¸²æŸ“ï¼Œç›´æ¥ä»åˆå§‹çŠ¶æ€è·³åˆ°æœ€ç»ˆçŠ¶æ€
});
```
### å¤šå±‚Canvas
Excalidraw é‡‡ç”¨äº†ä¸‰å±‚åˆ†ç¦»çš„ Canvas æ¸²æŸ“æ¶æ„: `é™æ€å†…å®¹å±‚`ã€`æ–°å…ƒç´ é¢„è§ˆå±‚`ã€`äº¤äº’UIå±‚`

#### å¤šå±‚ç»“æ„

**é™æ€å†…å®¹å±‚**ï¼šæ¸²æŸ“æ‰€æœ‰å·²ç¡®å®šçš„å›¾å½¢å…ƒç´ å’ŒèƒŒæ™¯ï¼ˆå¦‚æœæœ‰ç½‘æ ¼ï¼‰ï¼Œå¤„ç†æ’å…¥çš„å›¾ç‰‡ã€‚

**æ–°å…ƒç´ é¢„è§ˆå±‚**: æ˜¾ç¤ºç”¨æˆ·æ­£åœ¨ç»˜åˆ¶çš„å›¾å½¢ï¼Œåªåœ¨newElementå­˜åœ¨æ—¶ä¸´æ—¶æ¸²æŸ“é¼ æ ‡æ‹–æ‹½å’Œç§»åŠ¨çš„æ•ˆæœã€‚
```js
// åªæœ‰åœ¨æœ‰æ–°å…ƒç´ æ—¶æ‰æ¸²æŸ“æ­¤å±‚
{this.state.newElement && (
  <NewElementCanvas
    appState={this.state}
    scale={window.devicePixelRatio}
    newElement={this.state.newElement}  // ä¼ å…¥æ–°å…ƒç´ 
  />
)}
```

**äº¤äº’å¼UIå±‚ï¼š** å¤„ç†å…ƒç´ é€‰ä¸­æ—¶çš„`è¾¹æ¡†å’Œå¥æŸ„`ï¼Œè¿˜æœ‰`è¾…åŠ©çº¿`ã€`å¤šäººåä½œæŒ‡é’ˆ`

#### å¤šå±‚ç»“æ„çš„ä¼˜ç‚¹
##### æŒ‰éœ€æ›´æ–°
åˆ†å±‚æ¸²æŸ“ï¼Œåªæ›´æ–°å˜åŒ–çš„å±‚
```js
// StaticCanvas - åªåœ¨å†…å®¹å˜åŒ–æ—¶é‡ç»˜
useEffect(() => {
  renderStaticScene(/* ... */);
}, [
  elementsMap,        // å…ƒç´ æ”¹å˜
  appState.zoom,      // ç¼©æ”¾æ”¹å˜
  appState.scrollX,   // è§†å£æ”¹å˜
  appState.scrollY
]);

// NewElementCanvas - åªåœ¨ç»˜åˆ¶çŠ¶æ€æ—¶å­˜åœ¨
{this.state.newElement && <NewElementCanvas />}

// InteractiveCanvas - é¢‘ç¹æ›´æ–°ä½†å†…å®¹ç®€å•
useEffect(() => {
  renderInteractiveScene(/* ... */);
}); // æ¯æ¬¡éƒ½æ‰§è¡Œï¼Œä½†åªæ¸²æŸ“UIå…ƒç´ 
```
##### å†…å®¹åˆ†ç¦»
é‡å†…å®¹ å’Œ è½»å†…å®¹åˆ†ç¦»

StaticCanvas:     å¤æ‚å›¾å½¢ã€å›¾ç‰‡ã€ç½‘æ ¼     â†’ ä½é¢‘æ›´æ–°
NewElementCanvas: å•ä¸ªé¢„è§ˆå…ƒç´             â†’ ä¸­é¢‘æ›´æ–°  
InteractiveCanvas: é€‰æ‹©æ¡†ã€æŒ‡é’ˆã€è¾…åŠ©çº¿   â†’ é«˜é¢‘æ›´æ–°
### æ™ºèƒ½ç¼“å­˜
#### å…¨å±€ç¼“å­˜
Nonce-basedç¼“å­˜æœºåˆ¶ï¼Œæ•´ä¸ªåœºæ™¯ä¸‹ä»»ä½•å…ƒç´ å¢åˆ å’Œå˜åŒ–ï¼Œä¼šè§¦å‘æ–°çš„éšæœºæ•°ç”Ÿæˆï¼Œè¿›è€Œæ›´æ–°å…¨å±€çŠ¶æ€ã€‚
#### æ¸²æŸ“å™¨å±‚é¢çš„ç¼“å­˜
**Rendererç¼“å­˜**ï¼šï¼ˆè§†å£ã€ç¼©æ”¾ã€ç¼–è¾‘çŠ¶æ€ä¸å˜ + sceneNonceÂ ä¸å˜ï¼‰å³å‘½ä¸­ç¼“å­˜ï¼Œå…¶ä¸­çš„ä»»ä¸€å‚æ•°å˜åŒ–ï¼Œå°±é‡æ–°è®¡ç®—å¯è§å…ƒç´ 

**Canvasç¼“å­˜**
```js
// StaticCanvas.tsx & InteractiveCanvas.tsx
const areEqual = (prevProps, nextProps) => {
  if (
    prevProps.sceneNonce !== nextProps.sceneNonce ||     // åœºæ™¯å˜åŒ–
    prevProps.scale !== nextProps.scale ||               // ç¼©æ”¾å˜åŒ–  
    prevProps.elementsMap !== nextProps.elementsMap ||   // å…ƒç´ å˜åŒ–
    prevProps.visibleElements !== nextProps.visibleElements  // å¯è§æ€§å˜åŒ–
  ) {
    return false;  // éœ€è¦é‡æ–°æ¸²æŸ“
  }
  return isShallowEqual(/* ... */);  // æµ…æ¯”è¾ƒå…¶ä»–çŠ¶æ€
};

export default React.memo(StaticCanvas, areEqual);  // ç»„ä»¶çº§ç¼“å­˜
```
#### å…ƒç´ çº§åˆ«çš„ç¼“å­˜
Shapeç¼“å­˜æ˜¯å¯¹ `RoughJS` å‡ ä½•è·¯å¾„è®¡ç®—ç»“æœçš„ç¼“å­˜ã€‚æ¯ä¸ª `Excalidraw` å…ƒç´ éƒ½éœ€è¦ç”Ÿæˆå¯¹åº”çš„å‡ ä½•å½¢çŠ¶ç”¨äºæ¸²æŸ“å’Œç¢°æ’æ£€æµ‹ã€‚

ç¼“å­˜ç»“æ„å¦‚ä¸‹
```js
// packages/element/src/ShapeCache.ts
export class ShapeCache {
  private static rg = new RoughGenerator();  // ğŸ¨ RoughJS ç”Ÿæˆå™¨ï¼ˆå•ä¾‹ï¼‰
  private static cache = new WeakMap<ExcalidrawElement, ElementShape>();  // ğŸ—‚ï¸ ç¼“å­˜å­˜å‚¨,WeakMap

  public static get = (element) => ShapeCache.cache.get(element);
  public static set = (element, shape) => ShapeCache.cache.set(element, shape);
  public static delete = (element) => ShapeCache.cache.delete(element);
}
```
Shapeç”Ÿæˆæµç¨‹ï¼š
```js
// packages/element/src/ShapeCache.ts
public static generateElementShape = (element, renderConfig) => {
  // ğŸ” ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç¼“å­˜
  const cachedShape = renderConfig?.isExporting 
    ? undefined  // å¯¼å‡ºæ—¶å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
    : ShapeCache.get(element);
  
  if (cachedShape !== undefined) {
    return cachedShape;  // ğŸš€ ç¼“å­˜å‘½ä¸­ï¼
  }
  
  // ğŸ”„ ç¬¬äºŒæ­¥ï¼šæ¸…ç†å…³è”ç¼“å­˜
  elementWithCanvasCache.delete(element);  // æ¸…ç† Canvas ç¼“å­˜
  
  // ğŸ¨ ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæ–°çš„ Shape
  const shape = _generateElementShape(element, ShapeCache.rg, renderConfig);
  
  // ğŸ’¾ ç¬¬å››æ­¥ï¼šå­˜å‚¨åˆ°ç¼“å­˜
  ShapeCache.cache.set(element, shape);
  
  return shape;
};
```


### å¢é‡æ¸²æŸ“

### å†…å­˜ç®¡ç†å’ŒåŠ¨ç”»å¸§