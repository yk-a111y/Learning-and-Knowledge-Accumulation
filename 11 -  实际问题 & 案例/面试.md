
# æ•°å­—äººç¼–è¾‘å™¨

æ•°å­—äººé€‰æ‹©Fabricçš„åŸå› ï¼šhttps://juejin.cn/post/7243725952789217317  (2Då›¾å½¢åº“ä¼˜åŠ£)

## å†å²è®°å½•
å†å²è®°å½•ä¼˜åŒ–ä¸»è¦ç›®çš„åœ¨äºï¼šç”»é¢å…ƒç´ è¿‡å¤šï¼Œundo/redoä¼šé€ æˆç”»å¸ƒå¡é¡¿ï¼Œå°¤å…¶æ˜¯åœ¨è¿ç»­å¤šæ¬¡ç‚¹å‡»çš„æƒ…å†µä¸‹ï¼Œæç«¯æ¡ä»¶ä¼šå¯¼è‡´æµè§ˆå™¨å´©æºƒã€‚

### åˆ†å±‚ç¼“å­˜
å°†ç”»å¸ƒå…ƒç´ åˆ†ä¸ºï¼š**é™æ€å†…å®¹**ç¼“å­˜å±‚ï¼ˆèƒŒæ™¯ã€æ•°å­—äººã€æ–‡æœ¬ï¼‰ã€**åŠ¨æ€å†…å®¹**ç¼“å­˜å±‚ï¼ˆç›´æ’­é—´è£…é¥°å…ƒç´ ï¼‰ã€åˆæˆå±‚ï¼ˆå°†åŠ¨é™äºŒè€…ç»“åˆï¼Œæ˜¾ç¤ºåˆ°å‰å°ï¼‰
```js
class LayerRender {
  constructor(bufferSystem) {
	this.bufferSystem = bufferSystem;
	this.staticElements = []; // ä¸å¸¸å˜åŒ–çš„å…ƒç´ 
	this.dynamicElements = []; // ç»å¸¸å˜åŒ–çš„å…ƒç´ 
  };

  // ğŸŒŸ åˆ†å±‚æ¸²æŸ“ï¼Œåªé‡ç»˜å˜åŒ–çš„å±‚
  render() {
	// é™æ€å±‚ï¼ˆå¾ˆå°‘é‡ç»˜ï¼‰
	if (this.bufferSystem.staticBufferDirty) {
		this.renderStaticLayer();
		this.bufferSystem.staticBufferDirty = false;
	}
	
	// åŠ¨æ€å±‚ï¼ˆéœ€è¦é‡ç»˜æ—¶æ‰é‡ç»˜ï¼‰
	if (this.bufferSystem.dynamicBufferDirty) {
		this.renderDynamicLayer();
		this.bufferSystem.dynamicBufferDirty = false;
	}
	
	// åˆæˆæœ€ç»ˆç”»é¢
	this.compositeLayer();
  }

  compositeLayer() {
    const ctx = this.bufferSystem.compositeBuffer.ctx;
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        
	// åˆæˆå„å±‚
	ctx.drawImage(this.bufferSystem.staticBuffer.canvas, 0, 0);
	ctx.drawImage(this.bufferSystem.dynamicBuffer.canvas, 0, 0);
        
	// æ˜¾ç¤ºåˆ°å‰å°
	this.editor.displayCtx.clearRect(0, 0, this.editor.displayCanvas.width, this.editor.displayCanvas.height);
	this.editor.displayCtx.drawImage(this.bufferSystem.compositeBuffer.canvas, 0, 0);
    }
}
```

### æ™ºèƒ½ & ç¦»å± Canvas
åˆ›å»ºä¸€ä¸ªç¦»å±Canvasï¼Œå®½é«˜ä¸compositeBuffer.canvasç›¸åŒã€‚å°†å®Œæ•´çš„ç¼“å­˜æ•°æ®ä¿å­˜åˆ°ç¦»å±Canvasä¸­ï¼ŒçœŸæ­£éœ€è¦å±•ç¤ºçš„æ—¶å€™ï¼Œç›´æ¥è°ƒç”¨ä¸€æ¬¡`drawImage`æ–¹æ³•ï¼Œæé«˜æ•ˆç‡ã€‚

ä½¿ç”¨ç¦»å±canvaså¹¶ä¸æ˜¯åŒç¼“å†²ï¼Œè€Œæ˜¯æŠŠç¦»å±canvaså½“æˆä¸€ä¸ªç¼“å­˜åŒºã€‚æŠŠéœ€è¦é‡å¤ç»˜åˆ¶çš„ç”»é¢æ•°æ®è¿›è¡Œç¼“å­˜èµ·æ¥ï¼Œå‡å°‘è°ƒç”¨canvasçš„APIçš„æ¶ˆè€—

ç»˜åˆ¶æ—¶é—´è¾ƒé•¿å¯¼è‡´äº†é—ªå±ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯æ–°å»ºä¸€ä¸ª canvas ä½œä¸º **ç¼“å­˜ canvas**ï¼Œé€šè¿‡ ç¼“å­˜ canvas å®Œæˆç»˜åˆ¶è¿‡ç¨‹ï¼Œç»˜åˆ¶å®Œæˆåï¼Œç›´æ¥å°† ç¼“å­˜ canvas å¤åˆ¶åˆ°åŸæ¥çš„ canvas
```js
updateCanvas(){
    const canvas = document.getElementById('canvas'); // è·å–é¡µé¢ä¸­çš„ canvas
    const ctx = canvas.getContext('2d');
    
    const tempCanvas = document.createElement('canvas'); // æ–°å»ºä¸€ä¸ª canvas ä½œä¸ºç¼“å­˜ canvas
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = 1448; tempCanvas.height = 750; // è®¾ç½®å®½é«˜

    // å¼€å§‹ç»˜åˆ¶
    tempCtx.drawImage(bg,0,0); // èƒŒæ™¯
    ... // çœç•¥å…¶ä»–ç»˜åˆ¶è¿‡ç¨‹
    
    // ç¼“å­˜ canvas ç»˜åˆ¶å®Œæˆ
    
    ctx.clearRect(0,0,1448,750); // æ¸…ç©ºæ—§ canvas
    ctx.drawImage(tempCanvas,0,0); // *å…³é”®ä»£ç ï¼šå°†ç¼“å­˜ canvas å¤åˆ¶åˆ°æ—§çš„ canvas
}
```

ç¦»å±canvasè¿˜æœ‰ä¸€ä¸ª**æ³¨æ„äº‹é¡¹**ï¼Œå¦‚æœä½ åšçš„æ•ˆæœæ˜¯ä¼šå°†å¯¹è±¡ä¸åœåœ°åˆ›å»ºå’Œé”€æ¯ï¼Œè¯·æ…é‡ä½¿ç”¨ç¦»å±canvasï¼›

å› ä¸ºå¦‚æœè¿™æ ·ç»‘å®šï¼Œå½“å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œç¦»å±canvasä¹Ÿä¼šè¢«é”€æ¯ï¼Œè€Œå¤§é‡çš„ç¦»å±canvasä¸åœåœ°è¢«åˆ›å»ºå’Œé”€æ¯ï¼Œä¼šå¯¼è‡´canvas bufferè€—è´¹å¤§é‡GPUèµ„æºï¼Œå®¹æ˜“é€ æˆæµè§ˆå™¨å´©æºƒæˆ–è€…ä¸¥é‡å¡å¸§ç°è±¡ã€‚è§£å†³åŠæ³•å°±æ˜¯å¼„ä¸€ä¸ªç¦»å±canvasæ•°ç»„ï¼Œé¢„å…ˆè£…è¿›è¶³å¤Ÿæ•°é‡çš„ç¦»å±canvasï¼Œä»…å°†ä»ç„¶å­˜æ´»çš„å¯¹è±¡ç¼“å­˜èµ·æ¥ï¼Œå½“å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œå†è§£é™¤ç¼“å­˜ã€‚è¿™æ ·å°±ä¸ä¼šå¯¼è‡´ç¦»å±canvasè¢«é”€æ¯äº†ã€‚

â€œ-------------------------------------------------------------------------â€

ä¸šå†…ä¹Ÿæœ‰`å¢é‡å­˜å‚¨å†å²è®°å½•`çš„æ–¹æ¡ˆï¼Œå³æ¯æ¬¡å°å˜åŠ¨ä¸å­˜å‚¨æ•´ä¸ªCanvasæ•°æ®ï¼Œåªå¯¹æŒ‡å®šobjectIdçš„objectåšå˜åŒ–ï¼ŒèŠ‚çœå¤§é‡ç»˜åˆ¶æ—¶é—´ã€‚
## éŸ³é¢‘æ³¢å³°
## AIé…éŸ³å’Œå­—å¹•åˆ‡å‰²
## å›¾ç‰‡ä¼˜åŒ–ç­–ç•¥
ä» [[2- å‰ç«¯æ€§èƒ½ä¼˜åŒ–#å›¾ç‰‡æ‡’åŠ è½½ | å›¾ç‰‡æ‡’åŠ è½½]] å¼€å§‹
## é€šç”¨èµ„æºæ‡’åŠ è½½åº“
[[2- å‰ç«¯æ€§èƒ½ä¼˜åŒ–#é€šç”¨èµ„æºæ‡’åŠ è½½åº“ | é€šç”¨èµ„æºæ‡’åŠ è½½åº“]]
# äº‘å°åº—
## é£æ§
### è·ç¦»é£æ§
### ç”µè¯é£æ§
## åœ°å›¾ç“¦ç‰‡å¼æ¸²æŸ“

# FlowScriptæ’ä»¶
## MV3çƒ­æ›´æ–°
## ç”»å¸ƒä¸handler
## å·¥ä½œæµå¼•æ“
## JS handler
## é˜²è·¨åŸŸä»£ç æ³¨å…¥
# CodeGen_Vanilla
è¯¦è§ [[CodeGen_Vanilla | P2Cå¹³å°_CodeGen]]
# å‰ç«¯ç›‘æ§å¹³å°
è¯¦è§ [[1 - ç›‘æ§æµç¨‹è®¾è®¡ | ç›‘æ§æµç¨‹è®¾è®¡]]